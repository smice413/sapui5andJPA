/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/rta/plugin/Plugin","sap/ui/dt/ElementUtil","sap/ui/dt/OverlayRegistry","sap/ui/rta/Utils","sap/ui/fl/Utils","sap/ui/dt/Util","sap/ui/dt/ElementDesignTimeMetadata","sap/base/Log","sap/base/util/merge","sap/ui/fl/apply/api/DelegateMediatorAPI","sap/ui/core/util/reflection/JsControlTreeModifier"],function(P,E,O,U,F,D,a,L,m,b,J){"use strict";function _(s,i,q){var r;var R=i;if(q){var t=["add.delegate","reveal","add.custom"].some(function(w){return q.isResponsibleElementActionAvailable(i,w);});if(t){R=q.getResponsibleElementOverlay(i);}}var u=R.getRelevantContainer(!s);var v=O.getOverlay(u);if(s){r=R.getParentElementOverlay();}else{r=R;}return{responsibleElementOverlay:R,relevantContainerOverlay:v,parentOverlay:r,relevantContainer:u,parent:r&&r.getElement()};}function c(i,C){return C.sParentAggregationName;}function d(i,s){var q=i.getElement();if(!q){return[];}var I=E.getAggregation(q,s).filter(function(C){var r=O.getOverlay(C);if(!this.hasStableId(r)){return false;}var R=i.getRelevantContainer(true);var t=O.getOverlay(R);var u=i;var v=false;do{v=!u.getElementVisibility();if(v){break;}if(u===t){break;}else{u=u.getParentElementOverlay();}}while(u);if(v){return true;}return r.getElementVisibility()===false;},this);return I;}function e(i){return(i["addViaDelegate"]&&i["addViaDelegate"].designTimeMetadata)||(i["addViaCustom"]&&i["addViaCustom"].designTimeMetadata);}var S=true;var f=false;function g(r,i,q,s,C){var N=[];var t;var u;if(i.addViaCustom||i.addViaDelegate){var v=i.aggregation;var w=e(i);t=w.getAggregationDescription(v,q);if(t){u=s?t.singular:t.plural;N.push(u);}}if(i.reveal){i.reveal.controlTypeNames.forEach(function(t){u=s?t.singular:t.plural;N.push(u);});}var x=N.reduce(function(y,z){if(y.indexOf(z)===-1){y.push(z);}return y;},[]);var T=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");if(x.length===1){u=x[0];}else if(C){u=C;}else{u=T.getText("MULTIPLE_CONTROL_NAME");}return T.getText(r,[u]);}function h(i,r){var R;i.reveal.elements.some(function(q){if(q.element.getId()===r.getId()){R=q;return false;}});return R;}function j(i,q){var r=q.responsibleElementOverlay.getParentAggregationOverlay().getAggregationName();return i.aggregation===r;}function k(C,i,q,r){var v=q.changeType&&r.hasStableId(C);if(v&&C!==i.relevantContainerOverlay){v=r.hasStableId(i.relevantContainerOverlay);}return v;}function l(i,q,r){return i.reduce(function(s,t){return s.then(function(u){var C=t.changeOnRelevantContainer?q.relevantContainer:q.parent;var v=O.getOverlay(C);var V=k(v,q,t,r);if(V){t.element=C;return b.getDelegateForControl({control:q.relevantContainer,modifier:J,supportsDefault:t.supportsDefaultDelegate}).then(function(w){if(w&&w.name){t.delegateInfo=w;u.push(t);}return u;});}return u;});},Promise.resolve([]));}function n(i,q){return this.hasChangeHandler(i.changeType,i.element).then(function(H){if(H){return{aggregationName:i.aggregation,addPropertyActionData:{designTimeMetadata:q,action:i,delegateInfo:{payload:i.delegateInfo.payload||{},delegate:i.delegateInfo.instance,modelType:i.delegateInfo.modelType,requiredLibraries:i.delegateInfo.requiredLibraries}}};}});}function o(C,r){var i=C.getManifestEntry("/sap.ui5/dependencies/libs");return Object.keys(r).some(function(R){return!i[R];});}function p(){var i=[];var r=b.getKnownDefaultDelegateLibraries();r.forEach(function(s){var q=sap.ui.getCore().loadLibrary(s,{async:true}).catch(function(v){L.warning("Required library not available: ",v);return Promise.reject();});i.push(q);});return Promise.all(i);}var A=P.extend("sap.ui.rta.plugin.additionalElements.AdditionalElementsPlugin",{metadata:{library:"sap.ui.rta",properties:{analyzer:"object",dialog:"object",commandFactory:"object"},associations:{},events:{}},getContextMenuTitle:function(i,q){var r=_(i,q,this);var s=this._getActionsOrUndef(i,q);return g("CTX_ADD_ELEMENTS",s,r.parent,S);},isAvailable:function(i,q){return q.every(function(r){return this._isEditableByPlugin(r,i);},this);},isEnabled:function(i,q){if(q.length>1){return false;}var r=this.getResponsibleElementOverlay(q[0]);var s;var I;if(i){s=r.getParentElementOverlay();if(s){I=true;}else{I=false;}}else{var t=this._getActionsOrUndef(i,r);if((!t.reveal||t.reveal.elements.length===0)&&!t.addViaCustom&&!t.addViaDelegate){I=false;}else{I=true;}}var C=this.getCachedElements(i);var u=C&&C.length>0;I=I&&(u||this.getDialog().getCustomFieldEnabled());return I;},registerElementOverlay:function(i){var M=i.getElement().getModel();if(M){var q=M.getMetaModel();if(q&&q.loaded){q.loaded().then(function(){this.evaluateEditable([i],{onRegistration:true});}.bind(this));}}P.prototype.registerElementOverlay.apply(this,arguments);},_getRevealActions:function(s,i){var q=_(s,i,this);var r=[q.parentOverlay];if(q.relevantContainer!==q.parent){r=E.findAllSiblingsInContainer(q.parent,q.relevantContainer).map(function(v){return O.getOverlay(v);}).filter(function(v){return v;});}var t;if(s){var u=q.responsibleElementOverlay.getParentAggregationOverlay();t=u?[q.responsibleElementOverlay.getParentAggregationOverlay().getAggregationName()]:[];}else{t=q.parentOverlay.getAggregationOverlays().filter(function(v){return!v.getDesignTimeMetadata().isIgnored(q.parent);}).map(function(v){return v.getAggregationName();});}return t.reduce(function(v,w){return v.then(function(R){return this._getRevealActionFromAggregations(r,R,w);}.bind(this));}.bind(this),Promise.resolve({}));},_getRevealActionFromAggregations:function(i,q,s){var I=i.reduce(function(t,u){return u?t.concat(d.call(this,u,s)):t;}.bind(this),[]);var r={elements:[],controlTypeNames:[]};var R=I.reduce(function(t,u){return t.then(function(v){return this._invisibleToReveal(v,u);}.bind(this));}.bind(this),Promise.resolve(r));return R.then(function(t){if(t.elements.length>0){q[s]={reveal:t};}return q;});},_invisibleToReveal:function(r,i){return Promise.resolve().then(function(){var q;var R;var s=false;var H=Promise.resolve();var t=O.getOverlay(i);if(t){q=t.getDesignTimeMetadata();R=q&&q.getAction("reveal",i);if(R&&R.changeType){var u=i;if(R.changeOnRelevantContainer){u=t.getRelevantContainer();}H=this.hasChangeHandler(R.changeType,u).then(function(v){if(v){if(R.changeOnRelevantContainer){var w=_(true,t);s=this.hasStableId(w.relevantContainerOverlay)&&this.hasStableId(w.parentOverlay);}else{s=true;}if(!R.getAggregationName){R.getAggregationName=c;}}}.bind(this));}}return H.then(function(){if(s){r.elements.push({element:i,designTimeMetadata:q,action:R});var N=q.getName(i);if(N){r.controlTypeNames.push(N);}}return r;});}.bind(this));},_getAddViaDelegateActions:function(s,i){var q=_(s,i,this);var r=q.parentOverlay&&q.parentOverlay.getDesignTimeMetadata();return Promise.resolve().then(function(){var t=r?r.getActionDataFromAggregations("add",q.parent,undefined,"delegate"):[];if(t.length){return p().then(l.bind(this,t,q,this));}return[];}.bind(this)).then(function(t){return t.reduce(function(u,v){return u.then(function(R){return n.call(this,v,r).then(function(w){if(w){w.addPropertyActionData.relevantContainer=q.relevantContainer;if(!R[w.aggregationName]){R[w.aggregationName]={};}R[w.aggregationName].addViaDelegate=w.addPropertyActionData;}return R;});}.bind(this));}.bind(this),Promise.resolve({}));}.bind(this));},_checkInvalidAddActions:function(s,i){var q=_(s,i,this);var r=q.parentOverlay&&q.parentOverlay.getDesignTimeMetadata();var t=r?r.getActionDataFromAggregations("addODataProperty",q.parent):[];if(t.length>0){L.error("Outdated addODataProperty action in designtime metadata in "+r.getData().designtimeModule+" or propagated or via instance specific designtime metadata.");}},_getCustomAddActions:function(s,i){var q=_(s,i,this);var r=q.parentOverlay&&q.parentOverlay.getDesignTimeMetadata();var t=r&&r.getActionDataFromAggregations("add",q.parent,undefined,"custom")||[];function u(v,C){var I=[];return Promise.resolve().then(function(){if(v&&typeof v.getItems==="function"){var w=O.getOverlay(C);if(this.hasStableId(w)){return v.getItems(C);}}}.bind(this)).then(function(w){I=w;if(Array.isArray(I)){var x=I.reduce(function(y,z){if(z.changeSpecificData.changeOnRelevantContainer){C=q.relevantContainer;}if(z.changeSpecificData.changeType){y.push(this.hasChangeHandler(z.changeSpecificData.changeType,C));}return y;}.bind(this),[]);return Promise.all(x);}}.bind(this)).then(function(H){if(Array.isArray(H)&&I.length===H.length&&H.indexOf(false)===-1){return{aggregationName:v.aggregation,addViaCustom:{designTimeMetadata:r,action:v,items:I}};}});}var C=q.parent;return t.reduce(function(v,w){return v.then(function(R){return u.call(this,w,C).then(function(x){if(x){R[x.aggregationName]={addViaCustom:x.addViaCustom};}return R;});}.bind(this));}.bind(this),Promise.resolve({}));},_getActions:function(s,i,I){return new Promise(function(r,q){var t=s?"asSibling":"asChild";if(!I&&i._mAddActions){return r(i._mAddActions[t]);}var R=this._getRevealActions(s,i);var u=this._getAddViaDelegateActions(s,i);var C=this._getCustomAddActions(s,i);return Promise.all([R,u,C,this._checkInvalidAddActions(s,i)]).then(function(v){var w=m(v[0],v[1],v[2]);var x=Object.keys(w);if(x.length===0){w={};}else if(x.length>1){L.error("reveal or addViaDelegate or custom add action defined for more than 1 aggregation, that is not yet possible");}if(x.length>0){var y=x[0];w[y].aggregation=y;w=w[y];}i._mAddActions=i._mAddActions||{asSibling:{},asChild:{}};i._mAddActions[t]=w;r(w);}).catch(function(v){q(v);});}.bind(this));},_getActionsOrUndef:function(s,i){var q=s?"asSibling":"asChild";return i._mAddActions&&i._mAddActions[q];},_checkIfCreateFunctionIsAvailable:function(C){return!C||(C&&C.content&&C.content.createFunction);},showAvailableElements:function(i,r,I,C){var R=r[0];var q=_(i,R);var s=i&&R.getElement();var t;return this._getActions(i,R).then(function(u){t=u;}).then(function(){return this.getAllElements(i,[q.responsibleElementOverlay],I,C);}.bind(this)).then(function(u){this.getDialog().setElements(u);return this.getDialog().open().then(function(){return this._createCommands(q,s,t,I);}.bind(this)).then(function(){var v=O.getOverlay(s)||R;v.focus();}).catch(function(v){if(v instanceof Error){throw v;}});}.bind(this)).catch(function(u){if(u instanceof Error){throw u;}else{L.info("Service not up to date, skipping add dialog","sap.ui.rta");}});},_setDialogTitle:function(i,q,C){var s=g("HEADER_ADDITIONAL_ELEMENTS",i,q,f,C);this.getDialog().setTitle(s);if(C){this.getDialog()._oList.setNoDataText(this.getDialog()._oTextResources.getText("MSG_NO_FIELDS",C.toLowerCase()));}},_onOpenCustomField:function(){F.ifUShellContainerThen(function(s){var C=s[0];var H=(C&&C.hrefForExternal({target:{semanticObject:"CustomField",action:"develop"},params:{businessContexts:this._oCurrentFieldExtInfo.BusinessContexts.map(function(B){return B.BusinessContext;}),serviceName:this._oCurrentFieldExtInfo.ServiceName,serviceVersion:this._oCurrentFieldExtInfo.ServiceVersion,entityType:this._oCurrentFieldExtInfo.EntityType}}));U.openNewWindow(H);}.bind(this),["CrossApplicationNavigation"]);},_createCommands:function(i,s,q,I){var r=this.getDialog().getSelectedElements();r.sort(function(t,u){if(t.label>u.label){return-1;}if(t.label<u.label){return 1;}return 0;});if(r.length>0){return this.getCommandFactory().getCommandFor(i.parent,"composite").then(function(C){var t=Promise.resolve();r.forEach(function(u){switch(u.type){case"invisible":t=t.then(this._createCommandsForInvisibleElement.bind(this,C,u,i,s,q,I));break;case"delegate":t=t.then(this._createCommandsForAddViaDelegate.bind(this,C,u,i,s,q,I));break;case"custom":t=t.then(this._createCommandsForCustomElement.bind(this,C,u,i,s,q,I));break;default:L.error("Can't create command for untreated element.type "+u.type);}},this);return t.then(function(){return C;});}.bind(this)).then(function(C){this.fireElementModified({command:C});}.bind(this)).catch(function(M){throw D.propagateError(M,"AdditionalElementsPlugin#_createCommands","Error occured during _createCommands execution","sap.ui.rta.plugin");});}return Promise.resolve();},_createCommandsForInvisibleElement:function(C,s,i,q,r,I){return this._createRevealCommandForInvisible(s,r,i).then(function(R){C.addCommand(R);return this._createMoveCommandForInvisible(s,i,q,I);}.bind(this)).then(function(M){if(M){C.addCommand(M);}else{L.warning("No move action configured for "+i.parent.getMetadata().getName()+", aggregation: "+r.aggregation,"sap.ui.rta");}return C;});},_createCommandForAddLibrary:function(i,r,q){if(r){var C=F.getAppComponentForControl(i.relevantContainer);var s=o(C,r);if(s){var M=C.getManifest();var R=M["sap.app"].id;return this.getCommandFactory().getCommandFor(i.publicParent,"addLibrary",{reference:R,parameters:{libraries:r},appComponent:C},q);}}return Promise.resolve();},_createRevealCommandForInvisible:function(s,i,q){var r=E.getElementInstance(s.elementId);var R=O.getOverlay(r);var t=h(i,r);var u=t.designTimeMetadata;var v=t.action;var V;if(R){V=this.getVariantManagementReference(R);}if(v.changeOnRelevantContainer){return this.getCommandFactory().getCommandFor(r,"reveal",{revealedElementId:r.getId(),directParent:q.parent},u,V);}return this.getCommandFactory().getCommandFor(r,"reveal",{},u,V);},_createMoveCommandForInvisible:function(s,i,q,I){var r=E.getElementInstance(s.elementId);var R=O.getOverlay(r);var t=R.getParentAggregationOverlay().getAggregationName();var u=R.getParentElementOverlay().getElement()||i.parent;var T=i.parent;var v=U.getIndex(i.parent,q,t);var w=U.getIndex(u,r,t)-1;v=I!==undefined?I:E.adjustIndexForMove(u,T,w,v);if(v!==w||i.parent!==r.getParent()){var x=O.getOverlay(r)?O.getOverlay(r).getParentAggregationOverlay():i.relevantContainerOverlay;var y=x.getDesignTimeMetadata();var V=this.getVariantManagementReference(R);return this.getCommandFactory().getCommandFor(i.relevantContainer,"move",{movedElements:[{element:r,sourceIndex:w,targetIndex:v}],source:{parent:u,aggregation:t},target:{parent:T,aggregation:t}},y,V);}return Promise.resolve();},_createCommandsForCustomElement:function(C,s,i,q,r,I){var t=i.parent;var u=i.parentOverlay.getAggregationOverlay(r.aggregation).getDesignTimeMetadata();var v=Object.assign({changeOnRelevantContainer:s.changeSpecificData.changeOnRelevantContainer,aggregationName:r.aggregation,changeType:s.changeSpecificData.changeType,addElementInfo:s.changeSpecificData.content,index:I||U.getIndex(i.parent,q,r.aggregation)},s.itemId&&{customItemId:s.itemId});var V;if(i.relevantContainerOverlay){V=this.getVariantManagementReference(i.relevantContainerOverlay);}return this.getCommandFactory().getCommandFor(t,"customAdd",v,u,V).then(function(w){if(w){C.addCommand(w);}return C;});},_createCommandsForAddViaDelegate:function(C,s,i,q,r,I){var t=r.addViaDelegate.action;var R=t.delegateInfo.requiredLibraries;var u=i.parentOverlay.getAggregationOverlay(r.aggregation);var v=u.getDesignTimeMetadata();return this._createCommandForAddLibrary(i,R,v).then(function(w){if(w){C.addCommand(w);}return this._createAddViaDelegateCommand(s,i,v,q,r,I);}.bind(this)).then(function(w){if(w){C.addCommand(w);}return C;});},_createAddViaDelegateCommand:function(s,i,q,r,t,I){var u=t.addViaDelegate.action;var v=u.changeOnRelevantContainer?i.relevantContainer:i.parent;var w=u.changeOnRelevantContainer?i.relevantContainerOverlay:i.parentOverlay;var V=this.getVariantManagementReference(w);var x=U.getIndex(i.parent,r,t.aggregation,q.getData().getIndex);var C="addDelegateProperty";var M=F.getAppComponentForControl(i.parent).getManifest();var y=F.getODataServiceUriFromManifest(M);return this.getCommandFactory().getCommandFor(i.parent,C,{newControlId:U.createFieldLabelId(v,s.entityType,s.bindingPath),index:I!==undefined?I:x,bindingString:s.bindingPath,entityType:s.entityType,parentId:i.parent.getId(),propertyName:s.name,oDataServiceVersion:s.oDataServiceVersion,oDataServiceUri:y,modelType:u.delegateInfo.modelType,relevantContainerId:i.relevantContainer.getId()},q,V);},_isEditable:function(i,q){return Promise.all([this._isEditableCheck(q.sourceElementOverlay,true),this._isEditableCheck(q.sourceElementOverlay,false)]).then(function(r){return{asSibling:r[0],asChild:r[1]};}).catch(function(v){L.error(v);});},_isEditableCheck:function(i,q){return Promise.resolve().then(function(){var r=_(q,i,this);if(!r.relevantContainerOverlay){return false;}return this._getActions(q,i,true).then(function(s){return U.doIfAllControlsAreAvailable([i,r.parentOverlay],function(){var t=false;if(q){t=j(s,r);}if(!t&&s.reveal){t=true;}if(!t&&!q){if(s.addViaDelegate){return this.checkAggregationsOnSelf(r.parentOverlay,"add",undefined,"delegate");}}if(!t&&!q&&s.addViaCustom){t=true;}return t;}.bind(this));}.bind(this)).then(function(s){if(s){s=this.hasStableId(i)&&this.hasStableId(r.parentOverlay);}return s;}.bind(this));}.bind(this));},getAllElements:function(i,q,I,C){var r=q[0];var s=_(i,r,this);var t;var u=[];var v=this.getCachedElements(i);if(v){return v;}return this._getActions(i,r).then(function(w){t=w;u.push(t.reveal?this.getAnalyzer().enhanceInvisibleElements(s.parent,t):Promise.resolve([]),t.addViaDelegate?this.getAnalyzer().getUnrepresentedDelegateProperties(s.parent,t.addViaDelegate):Promise.resolve([]),t.addViaCustom?this.getAnalyzer().getCustomAddItems(s.parent,t.addViaCustom,t.aggregation):Promise.resolve([]));if(t.aggregation||C){this._setDialogTitle(t,s.parent,C);}}.bind(this)).then(function(){if(t.addViaDelegate){return U.isServiceUpToDate(s.parent);}}).then(function(){if(t.addViaDelegate){return U.isExtensibilityEnabledInSystem(s.parent);}this.getDialog()._oCustomFieldButton.setVisible(false);}.bind(this)).then(function(w){if(t.addViaDelegate){this.getDialog()._oCustomFieldButton.setVisible(w);this.getDialog().setCustomFieldEnabled(false);return U.isCustomFieldAvailable(s.parent);}}.bind(this)).then(function(w){if(w){this._oCurrentFieldExtInfo=w;this.getDialog().setCustomFieldEnabled(true);this.getDialog().addBusinessContext(this._oCurrentFieldExtInfo.BusinessContexts);this.getDialog().detachEvent('openCustomField',this._onOpenCustomField,this);this.getDialog().attachEvent('openCustomField',null,this._onOpenCustomField,this);}}.bind(this)).then(this._combineAnalyzerResults.bind(this,u)).then(function(w){this.setCachedElements(w,i);return w;}.bind(this)).catch(function(w){throw w;});},getMenuItems:function(q){var r=true;var s="CTX_ADD_ELEMENTS_AS_SIBLING";var R=20;var I="sap-icon://add";var M=[];this.clearCachedElements();return Promise.all([this.getAllElements(true,q),this.getAllElements(false,q)]).then(function(){for(var i=0;i<2;i++){if(this.isAvailable(r,q)){var G=this.getContextMenuTitle.bind(this,r);var t={id:s,text:G,handler:function(r,q){return this.showAvailableElements(r,q);}.bind(this,r),enabled:this.isEnabled.bind(this,r),rank:R,icon:I};M.push(this.enhanceItemWithResponsibleElement(t,q,["addViaDelegate","reveal","custom"]));}r=false;s="CTX_ADD_ELEMENTS_AS_CHILD";R=30;}return M;}.bind(this));},_combineAnalyzerResults:function(i){return Promise.all(i).then(function(q){return this.getAnalyzer().getFilteredItemsList(q);}.bind(this));},clearCachedElements:function(){this._aCachedElements=undefined;},setCachedElements:function(i,q){this._aCachedElements=this._aCachedElements||{};this._aCachedElements[q?"asSibling":"asChild"]=i;},getCachedElements:function(i){if(!this._aCachedElements){return undefined;}return this._aCachedElements[i?"asSibling":"asChild"];}});return A;});
