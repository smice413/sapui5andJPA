/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/includes","sap/base/util/restricted/_omit","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/changes/FlexCustomData","sap/ui/fl/apply/_internal/ChangesController","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/write/_internal/condenser/Condenser","sap/ui/fl/write/api/FeaturesAPI","sap/base/Log","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/write/_internal/flexState/FlexObjectState"],function(i,_,J,F,C,D,a,b,L,c,d,e){"use strict";function f(o){return(o._getMap&&i(D.getChangeTypes(),o._getMap().changeType))||(o.getChangeType&&i(D.getChangeTypes(),o.getChangeType()));}function h(p){p.includeCtrlVariants=true;p.invalidateCache=false;return P._getUIChanges(p).then(function(j){return j.length>0;});}function g(p){p.includeCtrlVariants=true;p.invalidateCache=false;return P._getUIChanges(p).then(function(j){return j.some(function(o){var s=o.getPackage();return s==="$TMP"||s==="";});});}var P={hasHigherLayerChanges:function(p){p.upToLayer=p.upToLayer||d.getCurrentLayer(false);return e.getFlexObjects(p).then(function(j){return j.filter(function(o){return d.isOverLayer(o.getLayer(),p.upToLayer);});}).then(function(j){return j.length>0;});},save:function(p){var o=C.getFlexControllerInstance(p.selector);var j=C.getDescriptorFlexControllerInstance(p.selector);p.invalidateCache=true;var A=C.getAppComponentForSelector(p.selector);p.componentId=A.getId();return o.saveAll(A,p.skipUpdateCache,p.draft,A).then(j.saveAll.bind(j,A,p.skipUpdateCache,p.draft)).then(P._getUIChanges.bind(null,_(p,"skipUpdateCache")));},getResetAndPublishInfo:function(p){return Promise.all([h(p),g(p),b.isPublishAvailable()]).then(function(r){var o={isResetEnabled:r[0],isPublishEnabled:r[1]};var j=r[2];var I=!(p.layer===c.USER)&&(!o.isResetEnabled||(j&&!o.isPublishEnabled));if(I){return C.getFlexControllerInstance(p.selector).getResetAndPublishInfo(p).then(function(R){o.isResetEnabled=o.isResetEnabled||R.isResetEnabled;o.isPublishEnabled=o.isPublishEnabled||R.isPublishEnabled;return o;}).catch(function(E){L.error("Sending request to flex/info route failed: "+E.message);return o;});}return o;});},reset:function(p){var A=C.getAppComponentForSelector(p.selector);var o=C.getFlexControllerInstance(A);var j=[p.layer,p.generator,A,p.selectorIds,p.changeTypes];return o.resetChanges.apply(o,j);},publish:function(p){p.styleClass=p.styleClass||"";var A=C.getAppComponentForSelector(p.selector);return C.getFlexControllerInstance(A)._oChangePersistence.transportAllUIChanges({},p.styleClass,p.layer,p.appVariantDescriptors);},add:function(p){if(f(p.change)){return p.change.store();}var A=C.getAppComponentForSelector(p.selector);return C.getFlexControllerInstance(A).addPreparedChange(p.change,A);},remove:function(p){if(!p.selector){throw new Error("An invalid selector was passed so change could not be removed with id: "+p.change.getId());}var A=C.getAppComponentForSelector(p.selector);if(!A){throw new Error("Invalid application component for selector, change could not be removed with id: "+p.change.getId());}if(f(p.change)){var o=C.getDescriptorFlexControllerInstance(A);o.deleteChange(p.change,A);return;}var E=J.bySelector(p.change.getSelector(),A);var j=C.getFlexControllerInstance(A);if(E){F.destroyAppliedCustomData(E,p.change,J);}j.deleteChange(p.change,A);},_condense:function(p){return Promise.resolve().then(function(){if(!p.selector){throw Error("An invalid selector was passed");}var A=C.getAppComponentForSelector(p.selector);if(!A){throw Error("Invalid application component for selector");}if(!p.changes||p.changes&&!Array.isArray(p.changes)){throw Error("Invalid array of changes");}return a.condense(A,p.changes);});},_getUIChanges:function(p){if(p.layer){p.currentLayer=p.layer;}return e.getFlexObjects(p);}};return P;});
