/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/merge","sap/base/util/ObjectPath","sap/ui/core/Component","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/apply/_internal/flexState/Loader","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/apply/_internal/flexState/prepareAppDescriptorMap","sap/ui/fl/apply/_internal/flexState/prepareChangesMap","sap/ui/fl/apply/_internal/flexState/prepareVariantsMap","sap/ui/fl/apply/_internal/flexState/prepareCompVariantsMap","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/base/Log"],function(m,O,C,S,L,M,p,a,b,c,d,U,e){"use strict";var F={};var _={};var f={};var g={};var h={appDescriptorMap:p,changesMap:a,variantsMap:b,compVariantsMap:c};function u(P){var A=C.get(P.componentId);_[P.reference].componentData=A?A.getComponentData():P.componentData;}function i(P){var A=C.get(P.componentId);P.componentData=P.componentData||A.getComponentData()||{};P.manifest=P.manifest||P.rawManifest||A.getManifestObject();P.reference=P.reference||M.getFlexReference(P);}function j(R,A){if(!_[R]){throw new Error("State is not yet initialized");}if(!_[R].preparedMaps[A]){var P={unfilteredStorageResponse:_[R].unfilteredStorageResponse,storageResponse:_[R].storageResponse,componentId:_[R].componentId,componentData:_[R].componentData};_[R].preparedMaps[A]=F._callPrepareFunction(A,P);}return _[R].preparedMaps[A];}function k(R){return j(R,"appDescriptorMap");}function l(R){return j(R,"changesMap");}function n(R){return j(R,"variantsMap");}function o(R){return j(R,"compVariantsMap");}function q(P){if(P.reference.endsWith(".Component")){var A=P.reference.split(".");A.pop();var R=A.join(".");_[R]=m({},{storageResponse:{changes:S.getEmptyFlexDataResponse()},unfilteredStorageResponse:{changes:S.getEmptyFlexDataResponse()},preparedMaps:{},componentId:P.componentId,partialFlexState:P.partialFlexState});g[R]=g[P.reference];}}function r(R){var A=m({},R);var B=A.changes;var D=["changes","variants","variantChanges","variantDependentControlChanges","variantManagementChanges"];if(d.isLayerFilteringRequired()){D.forEach(function(T){B[T]=d.filterChangeDefinitionsByMaxLayer(B[T]);});}return A;}function s(P){g[P.reference]=L.loadFlexData(P).then(function(R){_[P.reference]=m({},{unfilteredStorageResponse:R,preparedMaps:{},componentId:P.componentId,componentData:P.componentData,partialFlexState:P.partialFlexState});q(P);t(P.reference);return R;});return g[P.reference];}function t(R){U.ifUShellContainerThen(function(A){f[R]=w.bind(null,R);A[0].registerNavigationFilter(f[R]);},["ShellNavigation"]);}function v(R){U.ifUShellContainerThen(function(A){if(f[R]){A[0].unregisterNavigationFilter(f[R]);delete f[R];}},["ShellNavigation"]);}function w(R,N,A){return U.ifUShellContainerThen(function(B){try{var D=d.getMaxLayerTechnicalParameter(N);var P=d.getMaxLayerTechnicalParameter(A);if(D!==P){F.clearFilteredResponse(R);}}catch(E){e.error(E.message);}return B[0].NavigationFilterStatus.Continue;},["ShellNavigation"]);}function x(R){_[R].preparedMaps={};}function y(I){var A=_[I.reference];if(A.partialFlexState===true&&I.partialFlexState!==true){A.partialFlexState=false;I.partialFlexData=m({},A.unfilteredStorageResponse.changes);I.reInitialize=true;}return I;}function z(I){var A=_[I.reference].componentId;if(!I.reInitialize&&A!==I.componentId){I.reInitialize=true;}return I;}F.initialize=function(P){return Promise.resolve(P).then(function(I){i(I);var A=I.reference;if(g[A]){return g[A].then(y.bind(null,I)).then(z).then(function(E){return E.reInitialize?s(E):_[A].unfilteredStorageResponse;});}return s(I);}).then(function(P,R){if(!_[P.reference].storageResponse){_[P.reference].storageResponse=r(R);u(P);F.getVariantsState(P.reference);}}.bind(null,P));};F.clearAndInitialize=function(P){i(P);var V=!!O.get(["preparedMaps","variantsMap"],_[P.reference]);F.clearState(P.reference);F.clearState(U.normalizeReference(P.reference));return F.initialize(P).then(function(V,R){if(V){return F.getVariantsState(R);}}.bind(null,V,P.reference));};F.clearState=function(R){if(R){v(R);delete _[R];delete g[R];}else{Object.keys(_).forEach(function(R){v(R);});_={};g={};}};F.clearFilteredResponse=function(R){if(_[R]){x(R);delete _[R].storageResponse;}};F.getUIChanges=function(R){return l(R).changes;};F.getAppDescriptorChanges=function(R){return k(R).appDescriptorChanges;};F.getVariantsState=function(R){return n(R);};F.getUI2Personalization=function(R){return _[R].unfilteredStorageResponse.changes.ui2personalization;};F.getCompVariantsMap=function(R){return o(R).map;};F.getCompEntitiesByIdMap=function(R){return o(R).byId;};F._callPrepareFunction=function(A,P){return h[A](P);};F.getStorageResponse=function(R){if(g[R]){return g[R].then(function(){return _[R].unfilteredStorageResponse;});}};F.getFlexObjectsFromStorageResponse=function(R){return _[R]&&_[R].unfilteredStorageResponse.changes;};return F;},true);
