/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Fragment","sap/ui/thirdparty/jquery","sap/ui/fl/write/api/PersistenceWriteAPI","sap/ui/fl/Utils","sap/ui/model/json/JSONModel","sap/ui/rta/toolbar/ChangeIndicator","sap/ui/dt/OverlayRegistry","sap/ui/core/Component","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/changes/Utils","sap/m/library","sap/ui/fl/Layer","sap/base/util/each","sap/base/util/includes"],function(F,q,P,a,J,C,O,b,c,d,m,L,e,f){"use strict";var B=m.ButtonType;var g={changes:[],changeIndicators:[],rootControlId:""};g.updateCommandModel=function(){g.aValidCommands={all:["createContainer","addDelegateProperty","reveal","addIFrame","move","rename","combine","split","remove"],add:["createContainer","addDelegateProperty","reveal","addIFrame"],move:["move"],rename:["rename"],combinesplit:["combine","split"],remove:["remove"]};var o={commands:[]};var h=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");e(g.aValidCommands,function(k,v){o.commands.push({commands:v,text:h.getText("TXT_CHANGEVISUALIZATION_OVERVIEW_"+k.toUpperCase()),count:0,type:"Inactive"});});g.changes.forEach(function(j){var s=j.getDefinition().support.command;if(s!==""){e(g.aValidCommands,function(k,v){var I=v.indexOf(s);if(I>-1){var i=Object.keys(g.aValidCommands).indexOf(k);o.commands[i].count++;o.commands[i].type="Active";}});}});var M=new J(o);g.changesPopover.setModel(M,"commandModel");};g.removeChangeIndicators=function(){if(g.button&&g.changeIndicators){g.changeIndicators.forEach(function(o){o.changeIndicator.remove();o.changeIndicator.destroy();});g.switchChangeVisualizationActive();}g.changeIndicators=[];};g.hideChangeIndicators=function(){if(g.changeIndicators){g.changeIndicators.forEach(function(o){o.changeIndicator.hide();});}};g.revealChangeIndicators=function(){if(g.changeIndicators){g.changeIndicators.forEach(function(o){o.changeIndicator.reveal();});}};g.changeIndicatorsExist=function(){return g.changeIndicators.length>0;};g.switchChangeVisualizationActive=function(){var o=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");if(g.changeIndicators.length>0){g.button.setType(B.Emphasized);g.button.setTooltip(o.getText("BUT_CHANGEVISUALIZATION_HIDECHANGES"));q("body").on("keydown",function(E){if(E.key==="Escape"){g.removeChangeIndicators();}});}else{g.button.setType(B.Transparent);g.button.setTooltip(o.getText("BUT_CHANGEVISUALIZATION_SHOWCHANGES"));q("body").off("keydown");}};g.showSpecificChanges=function(E){g.changesPopover.close();var o=E.getSource().getBindingContext("commandModel");var h=o.getModel().getProperty(o.getPath()).commands;g.changes.forEach(function(i){var s=i.getDefinition().support.command;if(f(h,s)){g.getChangedElements(i,false).then(function(j){j.forEach(function(k){var l=g.createChangeIndicator(i,k,"change");if(l!==null){g.changeIndicators.push({elementId:l.getParentId(),changeIndicator:l});l.placeAt(sap.ui.getCore().getStaticAreaRef());}});g.switchChangeVisualizationActive();});}});};g.createChangeIndicator=function(o,h,s){var j=O.getOverlay(h);var k=o.getDefinition().support.command;while(!j||!j.isVisible()){if(k==="remove"){h=h.getParent();j=O.getOverlay(h.sId);}else{return null;}}var l=j.toString();var n="__"+l.split("__")[1];for(var i=0;i<g.changeIndicators.length;i++){if(g.changeIndicators[i].elementId===n&&s==="change"){g.changeIndicators[i].changeIndicator.addChange(o);return null;}}var p=new C({mode:s,parentId:n,changes:[]});p.addChange(o);p.setModel(g.button.getModel("i18n"),"i18n");p.hideChangeIndicators=g.hideChangeIndicators.bind(g);p.revealChangeIndicators=g.revealChangeIndicators.bind(g);p.createChangeIndicator=g.createChangeIndicator.bind(g);p.getChangedElements=g.getChangedElements.bind(g);return p;};g.getChangedElements=function(o,D){var h=b.get(g.rootControlId);return g.getInfoFromChangeHandler(h,o).then(function(i){var s=[o.getSelector()];if(i){if(D){s=i.dependentControls;}else{s=i.affectedControls;}}var p=[];s.forEach(function(S){p.push(c.bySelector(S,h));});return Promise.all(p);});};g.getChanges=function(){var o=b.get(g.rootControlId);var p={oComponent:o,selector:o,invalidateCache:false,includeVariants:true,currentLayer:L.CUSTOMER};return P._getUIChanges(p);};g.openChangePopover=function(o,r){g.button=o;g.rootControlId=r;return g.getChanges().then(function(h){g.changes=h;if(!g.changesPopover){return F.load({name:"sap.ui.rta.toolbar.Changes",id:"fragment_changeVisualization",controller:g}).then(function(p){g.changesPopover=p;g.updateCommandModel();g.changesPopover.openBy(o);return p;});}if(g.changesPopover.isOpen()){g.changesPopover.close();}else{g.updateCommandModel();g.changesPopover.openBy(o);}});};g.getInfoFromChangeHandler=function(A,o){var h=c.bySelector(o.getSelector(),A);if(h){var p={modifier:c,appComponent:A,view:a.getViewForControl(h)};var i=d.getControlIfTemplateAffected(o,h,p);return d.getChangeHandler(o,i,p).then(function(j){if(j&&typeof j.getChangeVisualizationInfo==="function"){return j.getChangeVisualizationInfo(o,A);}});}return Promise.resolve();};return g;});
