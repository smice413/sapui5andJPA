/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/documentation/sdk/controller/BaseController","sap/ui/thirdparty/URI","sap/base/Log"],function(B,U,L){"use strict";var T=sap.ui.require.toUrl("sap/ui/documentation/sdk/tmpl"),M=sap.ui.require.toUrl("sap/ui/demo/mock");var A={_fetchPromises:{},fetch:function(u){if(!(u in this._fetchPromises)){this._fetchPromises[u]=this._fetch(u);}return this._fetchPromises[u];},_fetch:function(u){return new Promise(function(r,a){var R,s,b=this._getExpectedResponseType(u);function h(e){s=e.type==="load"&&(R.status===200||R.status===0);if(!s){a(new Error("could not fetch '"+u+"': "+R.status));return;}r(A._readResponse(R));}R=new XMLHttpRequest();R.open("GET",u,true);R.responseType=b;R.onload=R.onerror=h;R.send();}.bind(this));},_readResponse:function(r){var R=r.responseType,o=(R==="text")?r.responseText:r.response;if(R==="arraybuffer"){try{o=new Uint8Array(o);}catch(e){}}return o;},_getExpectedResponseType:function(r){if(r.match(/.+(.vds|.pdf)$/i)){return"arraybuffer";}return"text";}};return B.extend("sap.ui.documentation.sdk.controller.SampleBaseController",{_aMockFiles:["products.json","supplier.json","img.json"],fetchSourceFile:function(u){return A.fetch(u).catch(function(e){L.warning(e);return"File not loaded";});},onDownload:function(){sap.ui.require(["sap/ui/thirdparty/jszip","sap/ui/core/util/File"],function(J,F){var z=new J(),r=sap.ui.require.toUrl((this._sId).replace(/\./g,"/")),d=this.oModel.getData(),e=d.includeInDownload||[],h,p=[],a=function(R){var m=[];for(var j=0;j<this._aMockFiles.length;j++){var s=this._aMockFiles[j];if((typeof R==="string")&&R.indexOf(s)>-1){m.push(this._addFileToZip({name:"mockdata/"+s,url:M+"/"+s,formatter:this._formatMockFile},z));}}return Promise.all(m);};for(var i=0;i<d.files.length;i++){var f=d.files[i],u=r+"/"+f.name,c=f.name&&(f.name===d.iframe||f.name.split(".").pop()==="html");p.push(this._addFileToZip({name:f.name,url:u,formatter:c?this._changeIframeBootstrapToCloud:undefined},z));p.push(this.fetchSourceFile(u).then(a.bind(this)));}if(!d.iframe){h=d.files.some(function(f){return f.name==="manifest.json";});p.push(this._addFileToZip({name:"Component.js",url:r+"/"+"Component.js"},z));p.push(this._addFileToZip({name:"index.html",url:T+"/"+(h?"indexevo.html.tmpl":"index.html.tmpl"),formatter:function(I){return this._changeIframeBootstrapToCloud(this._formatIndexHtmlFile(I,d));}.bind(this)},z));if(!h){p.push(this._addFileToZip({name:"index.js",url:T+"/"+"index.js.tmpl",formatter:function(I){return this._changeIframeBootstrapToCloud(this._formatIndexJsFile(I,d));}.bind(this)},z));}}e.forEach(function(s){p.push(this._addFileToZip({name:s,url:r+"/"+s},z));});
// add generic license and notice file
p.push(this._addFileToZip({name:"LICENSE.txt",url:T+"/"+"LICENSE.txt"},z));p.push(this._addFileToZip({name:"NOTICE.txt",url:T+"/"+"NOTICE.txt"},z));Promise.all(p).then(function(){var C=z.generate({type:"blob"});this._openGeneratedFile(C,this._sId);}.bind(this));}.bind(this));},_openGeneratedFile:function(c,i){sap.ui.require(["sap/ui/core/util/File"],function(F){F.save(c,i,"zip","application/zip");});},_addFileToZip:function(f,z){var F=f.name,u=f.url,a=f.formatter;return this.fetchSourceFile(u).then(function(r){if(a){r=a(r);}z.file(F,r);});},_formatIndexHtmlFile:function(f,d){return f.replace(/{{TITLE}}/g,d.name).replace(/{{SAMPLE_ID}}/g,d.id);},_formatIndexJsFile:function(f,d){return f.replace(/{{TITLE}}/g,d.name).replace(/{{SAMPLE_ID}}/g,d.id).replace(/{{HEIGHT}}/g,d.stretch?'height : "100%", ':"").replace(/{{SCROLLING}}/g,!d.stretch);},_formatMockFile:function(m){var w="test-resources/sap/ui/documentation/sdk/images/",c="https://openui5.hana.ondemand.com/test-resources/sap/ui/documentation/sdk/images/",r=new RegExp(w,"g");return m.replace(r,c);},_changeIframeBootstrapToCloud:function(r){var a=/src=(?:"[^"]*\/sap-ui-core\.js"|'[^']*\/sap-ui-core\.js')/,c=new U(document.baseURI).search(""),R=new U(sap.ui.require.toUrl("")+"/sap-ui-core.js"),b=R.absoluteTo(c).toString();return r.replace(a,'src="'+b+'"');}});});
